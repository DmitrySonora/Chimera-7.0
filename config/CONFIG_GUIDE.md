# Руководство по конфигурации Химера 2.0

## Лимиты демо-доступа
- `DAILY_MESSAGE_LIMIT` - количество сообщений в день для неавторизованных пользователей (по умолчанию: 10)

## Промпты и генерация

### Параметры генерации
- `GENERATION_PARAMS` - словарь параметров для DeepSeek:
  - `temperature` - креативность ответов (0.0-2.0)
  - `top_p` - nucleus sampling параметр (0.0-1.0)
  - `max_tokens` - максимальная длина ответа
  - `frequency_penalty` - штраф за повторения
  - `presence_penalty` - штраф за упоминание тем
  
### Режимно-зависимые параметры генерации

- `MODE_GENERATION_PARAMS` - словарь параметров для каждого режима общения:
  - `base` - базовые параметры (используют GENERATION_PARAMS)
  - `talk` - параметры для режима беседы:
    - temperature: 0.92 (высокая для эмоциональности)
    - top_p: 0.92 (высокий для разнообразия)
    - max_tokens: 1000 (меньше для динамичности диалога)
    - frequency_penalty: 0.35 (низкий для естественности)
    - presence_penalty: 0.5 (средний)
  - `expert` - параметры для экспертного режима:
    - temperature: 0.55 (низкая для точности и фактологичности)
    - top_p: 0.8 (консервативный выбор слов)
    - max_tokens: 1500 (больше для развернутых объяснений)
    - frequency_penalty: 0.65 (высокий для избежания повторов)
    - presence_penalty: 0.72 (высокий для разнообразия тем)
  - `creative` - параметры для творческого режима:
    - temperature: 0.75 (средняя с уклоном в креативность)
    - top_p: 0.97 (очень высокий для неожиданных выборов)
    - max_tokens: 2200 (максимум для богатых текстов)
    - frequency_penalty: 0.25 (низкий для поэтических повторов)
    - presence_penalty: 0.78 (высокий для оригинальности)

Параметры автоматически применяются при определении режима в UserSessionActor.

- `GENERATION_PARAMS_LOG_CONFIG` - настройки логирования параметров:
  - `log_parameters_usage` - логировать использованные параметры в Event Store (по умолчанию: True)
  - `log_response_length` - включать длину ответа в логи (по умолчанию: True)
  - `debug_mode_selection` - подробное логирование выбора режима (по умолчанию: False)

### Управление промптами
- `PROMPT_CONFIG` - настройки системного промпта:
  - `system_prompt_interval` - включать промпт каждое N сообщение
  - `enable_periodic_prompt` - включить периодичность
  - `prompt_strategy` - стратегия: "always", "periodic", "adaptive"
  - `use_json_mode` - использовать JSON формат ответов
  - `json_fallback_enabled` - автоматический fallback при ошибке JSON
  - `log_prompt_usage` - логировать использование промптов в консоль (по умолчанию: True)
  - `log_prompt_preview_length` - количество символов промпта для показа в логах (по умолчанию: 100)
  
### JSON-заглушка для периодических промптов
- `JSON_STUB_PROMPT` - минимальный промпт-заглушка при отключенном основном промпте (по умолчанию: "Ты — Химера, гениальная девушка. Ответь только в формате json: {\"response\": \"твой ответ\"}")
  - Используется когда `enable_periodic_prompt = True` и промпт не включается
  - Обеспечивает наличие слова "json" для DeepSeek API
  - Минимальное влияние на поведение Химеры

### Логирование параметров генерации
- `GENERATION_PARAMS_LOG_CONFIG` - настройки логирования параметров генерации:
  - `log_parameters_usage` - сохранять ли использованные параметры в Event Store (по умолчанию: True)
  - `log_response_length` - включать ли длину ответа в события (по умолчанию: True)
  - `debug_mode_selection` - выводить ли подробную отладку при выборе режима (по умолчанию: False)

При включенном `log_parameters_usage` система создает события `GenerationParametersUsedEvent` для каждой генерации, содержащие:
- Использованный режим (talk/expert/creative/base)
- Все параметры генерации (temperature, top_p, max_tokens и др.)
- Длину сгенерированного ответа (если включен `log_response_length`)
- ID пользователя и временную метку

Это позволяет анализировать эффективность разных параметров и оптимизировать генерацию.

### Валидация структурированных ответов
- `JSON_VALIDATION_CONFIG` - настройки валидации JSON-ответов:
  - `strict_mode` - требовать все опциональные поля (по умолчанию: False)
  - `log_validation_errors` - логировать ошибки валидации (по умолчанию: True)
  - `validation_timeout_ms` - таймаут валидации в миллисекундах (по умолчанию: 10)
  - `max_validation_errors` - максимум ошибок в одном логе (по умолчанию: 5)

- `JSON_SCHEMA_INSTRUCTIONS` - инструкции для структурированных ответов по режимам:
  - `talk` - схема с emotional_tone и engagement_level
  - `expert` - схема с confidence, sources и assumptions
  - `creative` - схема с style_markers и metaphors
  
### Настройка режимных промптов

- `MODE_PROMPT_CONFIG` - управление построением промптов для режимов:
  - `use_mode_modifiers` - использовать ли модификаторы режимов (по умолчанию: True)
  - `combine_with_base` - комбинировать базовый промпт с модификатором (по умолчанию: True)
  - `modifier_separator` - разделитель между базой и модификатором (по умолчанию: "\n\n")

### Примечания по режимным промптам
1. **Архитектура промптов** - базовый промпт всегда используется, модификаторы добавляются к нему
2. **TODO-маркеры** - текущие модификаторы содержат TODO для будущей реализации
3. **Fallback** - если модификатор содержит TODO или отсутствует, используется только базовый промпт

## Определение режимов общения

### Настройки истории и уверенности
- `MODE_HISTORY_SIZE` - максимальный размер истории режимов для отслеживания паттернов общения (по умолчанию: 5)
- `MODE_CONFIDENCE_THRESHOLD` - минимальная уверенность для режима по умолчанию при отсутствии явных паттернов (по умолчанию: 0.3)
- `MODE_SCORE_NORMALIZATION_FACTOR` - делитель для нормализации уверенности в определении режима (по умолчанию: 1.5)

### Контекстные паттерны
- `CONTEXTUAL_PATTERN_PHRASE_WEIGHT` - вес для точных фраз при определении режима (по умолчанию: 2.5)
- `CONTEXTUAL_PATTERN_DOMAIN_WEIGHT` - вес для доменных маркеров (по умолчанию: 0.5)
- `CONTEXTUAL_PATTERN_CONTEXT_MULTIPLIER` - множитель для контекстных слов с усилителями (по умолчанию: 1.5)
- `CONTEXTUAL_PATTERN_SUPPRESSOR_MULTIPLIER` - множитель для контекстных слов с подавителями (по умолчанию: 0.3)

### Производительность определения режимов
- `MODE_DETECTION_CACHE_ENABLED` - включить кэширование результатов определения паттернов (по умолчанию: True)
- `MODE_DETECTION_MAX_TIME_MS` - максимальное время определения режима в миллисекундах (по умолчанию: 5)
- `MODE_DETECTION_DEBUG_LOGGING` - включить подробное логирование процесса определения режима (по умолчанию: True)

### Примечания по контекстным паттернам
1. **Трехуровневая система** обрабатывает паттерны с разными приоритетами:
   - Точные фразы (вес 2.5) - максимальный приоритет
   - Контекстные слова с модификаторами - средний приоритет
   - Доменные маркеры (вес 0.5) - минимальный приоритет

2. **Усилители и подавители** позволяют учитывать контекст многозначных слов. Например, "объясни устройство" → expert, но "объясни, почему мне плохо" → talk.

3. **События PatternDebugEvent** сохраняются при включенном MODE_DETECTION_DEBUG_LOGGING для анализа работы системы.

### Примечания по режимам
1. **История режимов** используется для усиления уверенности при стабильном паттерне общения. Если последние 3 сообщения были в одном режиме, уверенность умножается на `stable_history_multiplier` из `prompts.py`.

2. **Нормализация уверенности** преобразует сырые очки паттернов в значение от 0 до 1. Меньший делитель = выше уверенность.

3. **Пороговое значение** используется как fallback уверенность когда текст слишком короткий или не содержит паттернов.

## Actor System

### Основные настройки
- `ACTOR_SYSTEM_NAME` - имя системы акторов для логирования (по умолчанию: "chimera")
- `ACTOR_MESSAGE_QUEUE_SIZE` - максимальный размер очереди сообщений для каждого актора (по умолчанию: 1000)
- `ACTOR_SHUTDOWN_TIMEOUT` - время ожидания graceful shutdown в секундах (по умолчанию: 5.0)
- `ACTOR_MESSAGE_TIMEOUT` - таймаут ожидания нового сообщения в message loop (по умолчанию: 1.0)

### Retry механизм
- `ACTOR_MESSAGE_RETRY_ENABLED` - включить механизм повторной отправки сообщений при переполнении очереди (по умолчанию: True)
- `ACTOR_MESSAGE_MAX_RETRIES` - максимальное количество попыток отправки сообщения (по умолчанию: 3)
- `ACTOR_MESSAGE_RETRY_DELAY` - начальная задержка между попытками в секундах (по умолчанию: 0.1)
- `ACTOR_MESSAGE_RETRY_MAX_DELAY` - максимальная задержка между попытками в секундах (по умолчанию: 2.0)

### Dead Letter Queue
- `DLQ_MAX_SIZE` - максимальный размер Dead Letter Queue перед автоочисткой (по умолчанию: 1000)
- `DLQ_CLEANUP_INTERVAL` - интервал автоматической очистки DLQ в секундах (по умолчанию: 3600)
- `DLQ_METRICS_ENABLED` - включить сбор метрик по Dead Letter Queue (по умолчанию: True)

## Логирование

### Основные настройки
- `LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR) (по умолчанию: "INFO")
- `LOG_FORMAT` - формат сообщений логов (по умолчанию: "%(asctime)s - %(name)s - %(levelname)s - %(message)s")
- `LOG_DATE_FORMAT` - формат даты в логах (по умолчанию: "%Y-%m-%d %H:%M:%S")

### JSON логирование
- `ENABLE_JSON_LOGGING` - включить JSON логирование параллельно с текстовым (по умолчанию: True)
- `JSON_LOG_FILE` - путь к файлу JSON логов (по умолчанию: "logs/chimera.json")

### Ротация логов
- `LOG_ROTATION_ENABLED` - включить автоматическую ротацию файлов логов (по умолчанию: True)
- `LOG_MAX_BYTES` - максимальный размер файла логов в байтах перед ротацией (по умолчанию: 1048576 = 1 МБ)
- `LOG_BACKUP_COUNT` - количество архивных файлов логов для хранения (по умолчанию: 5)

## Мониторинг

### Метрики производительности
- `ENABLE_PERFORMANCE_METRICS` - включить сбор метрик производительности (по умолчанию: True)
- `METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 60)
- `SLOW_OPERATION_THRESHOLD` - порог в секундах для определения медленных операций (по умолчанию: 0.1)

## Event Store

### Основные настройки
- `EVENT_STORE_TYPE` - тип хранилища событий: "memory" для in-memory, будет "postgres" в фазе 3 (по умолчанию: "memory")
- `EVENT_STORE_MAX_MEMORY_EVENTS` - максимальное количество событий в памяти перед автоочисткой (по умолчанию: 10000)
- `EVENT_STORE_STREAM_CACHE_SIZE` - размер LRU кэша для часто используемых потоков событий (по умолчанию: 100)
- `EVENT_STORE_CLEANUP_INTERVAL` - интервал автоматической очистки старых событий в секундах (по умолчанию: 3600)
- `EVENT_STORE_CLEANUP_BATCH_SIZE` - количество событий удаляемых за одну операцию очистки (по умолчанию: 100)

### Сериализация событий
- `EVENT_SERIALIZATION_FORMAT` - формат сериализации событий (по умолчанию: "json")
- `EVENT_TIMESTAMP_FORMAT` - формат timestamp для сериализации событий (по умолчанию: "%Y-%m-%dT%H:%M:%S.%fZ")

## Event Archival (Архивация событий)

### Основные настройки архивации
- `ARCHIVE_ENABLED` - включить автоматическую архивацию старых событий (по умолчанию: True)
- `ARCHIVE_DAYS_THRESHOLD` - архивировать события старше указанного количества дней (по умолчанию: 90)
- `ARCHIVE_BATCH_SIZE` - количество событий для архивации за одну транзакцию (по умолчанию: 1000)
- `ARCHIVE_COMPRESSION_LEVEL` - уровень сжатия gzip от 1 до 9, где 6 - баланс скорости и сжатия (по умолчанию: 6)

### Расписание архивации
- `ARCHIVE_SCHEDULE_HOUR` - час запуска архивации в UTC (по умолчанию: 4)
- `ARCHIVE_SCHEDULE_MINUTE` - минута запуска архивации (по умолчанию: 0)
- `ARCHIVE_QUERY_TIMEOUT` - таймаут для запросов архивации в секундах (по умолчанию: 30.0)
- `ARCHIVE_DRY_RUN` - режим тестирования: только логирование без реального удаления (по умолчанию: False)

## Storage Monitoring (Мониторинг хранилища)

### Основные настройки мониторинга
- `STORAGE_MONITORING_ENABLED` - включить мониторинг размеров таблиц БД (по умолчанию: True)
- `STORAGE_CHECK_INTERVAL` - интервал проверки размеров в секундах (по умолчанию: 3600 - каждый час)
- `STORAGE_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 86400 - раз в сутки)

### Пороги алертов
- `STORAGE_ALERT_THRESHOLD_MB` - порог предупреждения о размере таблицы в МБ (по умолчанию: 1000)
- `STORAGE_CRITICAL_THRESHOLD_MB` - критический порог размера таблицы в МБ (по умолчанию: 5000)
- `STORAGE_GROWTH_WINDOW_DAYS` - окно анализа роста БД в днях для прогнозирования (по умолчанию: 7)
- `STORAGE_GROWTH_ALERT_THRESHOLD` - порог алерта при прогнозе роста, 1.5 = рост на 50% (по умолчанию: 1.5)

## SystemActor (Системный актор)

### Настройки системного актора
- `SYSTEM_ACTOR_ENABLED` - включить SystemActor для maintenance задач (по умолчанию: True)
- `SYSTEM_METRICS_CACHE_TTL` - время жизни кэша метрик в секундах (по умолчанию: 300 - 5 минут)
- `SYSTEM_ALERT_COOLDOWN` - минимальный интервал между одинаковыми алертами в секундах (по умолчанию: 3600 - 1 час)

## Настройки Event Replay Service (аналитика событий)
- `EVENT_REPLAY_MAX_EVENTS` - максимальное количество событий, возвращаемых за один запрос (по умолчанию: 10000)
- `EVENT_REPLAY_BATCH_SIZE` - размер батча при чтении больших объемов данных из БД (по умолчанию: 5000)
- `EVENT_REPLAY_DEFAULT_PERIOD_DAYS` - период анализа по умолчанию для метода get_trigger_distribution в днях (по умолчанию: 7)
- `EVENT_REPLAY_CACHE_TTL` - время жизни кэша для метрик в секундах, зарезервировано для будущего использования (по умолчанию: 300 - 5 минут)

## ПАРАМЕТРЫ EVENT REPLAY SERVICE

### Event Replay Service settings:
- `EVENT_REPLAY_MAX_EVENTS` - максимальное количество событий, возвращаемых за один запрос (по умолчанию: 10000)
- `EVENT_REPLAY_BATCH_SIZE` - размер батча при чтении больших объемов данных из БД (по умолчанию: 5000)
- `EVENT_REPLAY_DEFAULT_PERIOD_DAYS` - период анализа по умолчанию для метода get_trigger_distribution в днях (по умолчанию: 7)
- `EVENT_REPLAY_CACHE_TTL` - время жизни кэша для метрик в секундах, зарезервировано для будущего использования (по умолчанию: 300 - 5 минут)
- `ANALYSIS_CACHE_TTL_DAYS` - время жизни кэша результатов анализа в днях (по умолчанию: 30)
- `ANALYSIS_CACHE_TABLE` - название таблицы для кэширования результатов эмоционального анализа (по умолчанию: "emotional_analysis_cache")
- `ANALYSIS_MAX_EVENTS_PER_USER` - максимальное количество эмоциональных событий для анализа одного пользователя (по умолчанию: 10000)
- `ANALYSIS_BATCH_SIZE` - размер батча при обработке больших объемов эмоциональных данных (по умолчанию: 500)
- `CLUSTERING_MIN_K` - минимальное количество кластеров для K-means анализа (по умолчанию: 3)
- `CLUSTERING_MAX_K` - максимальное количество кластеров для K-means анализа (по умолчанию: 10)
- `CLUSTERING_SILHOUETTE_THRESHOLD` - минимальный порог силуэтного коэффициента для валидации качества кластеризации (по умолчанию: 0.5)
- `PATTERN_MIN_FREQUENCY` - минимальная частота повторения для определения устойчивого эмоционального паттерна (по умолчанию: 3)
- `PATTERN_MIN_CONFIDENCE` - минимальный уровень уверенности для детекции паттернов от 0.0 до 1.0 (по умолчанию: 0.7)
- `TEMPORAL_WINDOW_MINUTES` - временное окно в минутах для группировки связанных эмоциональных событий (по умолчанию: 30)
- `ANOMALY_CONTAMINATION` - ожидаемая доля аномалий в данных от 0.0 до 1.0 (по умолчанию: 0.05 - 5%)
- `ANOMALY_Z_SCORE_THRESHOLD` - порог Z-score для детекции эмоциональных аномалий (по умолчанию: 3.0)
- `CYCLE_MIN_PERIOD_DAYS` - минимальный период эмоционального цикла в днях (по умолчанию: 3)
- `CYCLE_MAX_PERIOD_DAYS` - максимальный период эмоционального цикла в днях (по умолчанию: 30)
- `CYCLE_MIN_AMPLITUDE` - минимальная амплитуда эмоциональных колебаний для детекции цикла от 0.0 до 1.0 (по умолчанию: 0.2)


## PostgreSQL Event Store

### Подключение к базе данных
- `POSTGRES_DSN` - строка подключения к PostgreSQL (по умолчанию: "postgresql://chimera:password@localhost:5432/chimera_db")
- `POSTGRES_POOL_MIN_SIZE` - минимальный размер пула подключений (по умолчанию: 10)
- `POSTGRES_POOL_MAX_SIZE` - максимальный размер пула подключений (по умолчанию: 20)
- `POSTGRES_COMMAND_TIMEOUT` - таймаут выполнения команд в секундах (по умолчанию: 60)
- `POSTGRES_CONNECT_TIMEOUT` - таймаут подключения к БД в секундах (по умолчанию: 10)
- `POSTGRES_RETRY_ATTEMPTS` - количество попыток подключения при сбое (по умолчанию: 3)
- `POSTGRES_RETRY_DELAY` - задержка между попытками подключения в секундах (по умолчанию: 1.0)

### Батчевая запись событий
- `EVENT_STORE_BATCH_SIZE` - количество событий для батчевой записи (по умолчанию: 100)
- `EVENT_STORE_FLUSH_INTERVAL` - интервал автоматической записи буфера в секундах (по умолчанию: 1.0)
- `EVENT_STORE_MAX_BUFFER_SIZE` - максимальный размер буфера до принудительной записи (по умолчанию: 1000)

### Миграция данных
- `EVENT_STORE_MIGRATION_BATCH` - размер батча при миграции событий (по умолчанию: 1000)
- `EVENT_STORE_MIGRATION_DELAY` - задержка между батчами для снижения нагрузки в секундах (по умолчанию: 0.1)
- `EVENT_STORE_MIGRATION_VERIFY` - выполнять ли верификацию после миграции (по умолчанию: True)
### Advisory lock настройки
- `USE_DOUBLE_KEY_ADVISORY_LOCK` - использовать два int4 ключа вместо одного для advisory locks, что значительно снижает вероятность коллизий хэшей (по умолчанию: True)

### Переключение реализации
- `EVENT_STORE_TYPE` - тип используемого Event Store: "memory" или "postgres" (по умолчанию: "memory")

### Примечания по настройке

1. **Размер пула подключений** зависит от количества акторов:
   - Для 3-5 акторов: min=10, max=20
   - Для 10+ акторов: min=20, max=50
   - Учитывайте лимиты PostgreSQL на количество подключений

2. **Батчевая запись** критична для производительности:
   - Маленький батч (10-50) = низкая латентность, больше нагрузка на БД
   - Большой батч (200-500) = высокая латентность, эффективная запись
   - Оптимально: 100-200 событий

3. **Буфер записи** защищает от потери событий:
   - При сбое БД события накапливаются в буфере
   - При превышении MAX_BUFFER_SIZE происходит принудительная запись
   - Размер буфера = BATCH_SIZE * 10 (запас на 10 батчей)

4. **Миграция** выполняется без остановки системы:
   - Сначала переключите EVENT_STORE_TYPE на "postgres"
   - Перезапустите приложение (начнет писать в PostgreSQL)
   - Запустите миграцию старых данных: `python -m database.event_store_migrator`

### Требования к PostgreSQL

- PostgreSQL 12+ (для оптимальной работы с JSONB)
- Расширение uuid-ossp: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`
- Минимум 2GB RAM для эффективной работы
- SSD диск рекомендуется для Event Store

### Оценка размера БД

- 1 событие ≈ 1KB (с индексами)
- 1 миллион событий ≈ 1GB
- Индексы добавляют ~30% к размеру данных
- Планируйте x3 от ожидаемого размера для роста

## Примечания

1. **Retry механизм** использует exponential backoff - каждая следующая попытка происходит через удвоенное время, но не более `ACTOR_MESSAGE_RETRY_MAX_DELAY`.

2. **Dead Letter Queue** сохраняет сообщения, которые не удалось доставить после всех попыток. Автоочистка удаляет старые сообщения при превышении `DLQ_MAX_SIZE`.

3. **Метрики производительности** логируются только для операций, превышающих `SLOW_OPERATION_THRESHOLD` секунд.

4. **Ротация логов** автоматически архивирует файл логов при достижении `LOG_MAX_BYTES`. Архивные файлы именуются как `chimera.json.1`, `chimera.json.2` и т.д. Когда количество архивов превышает `LOG_BACKUP_COUNT`, самый старый файл удаляется.

## Redis

### Подключение
- `REDIS_URL` - URL подключения к Redis (по умолчанию: "redis://localhost:6379/0")
- `REDIS_POOL_MIN_SIZE` - минимальный размер пула подключений (по умолчанию: 5)
- `REDIS_POOL_MAX_SIZE` - максимальный размер пула подключений (по умолчанию: 10)
- `REDIS_CONNECT_TIMEOUT` - таймаут подключения в секундах (по умолчанию: 5)
- `REDIS_RETRY_ATTEMPTS` - количество попыток подключения при сбое (по умолчанию: 3)
- `REDIS_RETRY_DELAY` - задержка между попытками подключения в секундах (по умолчанию: 1.0)

### Настройки ключей
- `REDIS_KEY_PREFIX` - префикс для всех ключей Redis (по умолчанию: "chimera")
  - Помогает избежать коллизий при использовании общего Redis
  - Все ключи будут иметь формат: `chimera:key_name`
- `REDIS_DAILY_LIMIT_TTL` - время жизни счетчиков лимитов в секундах (по умолчанию: 86400 = 24 часа)
  - Автоматически удаляет устаревшие счетчики
  - Синхронизировано с ежедневным сбросом лимитов

### Рекомендации по настройке
1. **Размер пула подключений** зависит от нагрузки:
   - Для малых нагрузок: min=5, max=10
   - Для средних нагрузок: min=10, max=20
   - Для высоких нагрузок: min=20, max=50

2. **Таймауты** важны для стабильности:
   - Увеличьте CONNECT_TIMEOUT при нестабильной сети
   - Увеличьте RETRY_DELAY при высокой нагрузке на Redis

## DeepSeek API

### Основные настройки
- `DEEPSEEK_API_KEY` - API ключ для доступа к DeepSeek (обязательный)
- `DEEPSEEK_BASE_URL` - базовый URL API (по умолчанию: "https://api.deepseek.com/v1")
- `DEEPSEEK_MODEL` - модель для использования (по умолчанию: "deepseek-chat")
- `DEEPSEEK_TIMEOUT` - таймаут запросов в секундах (по умолчанию: 30)
- `DEEPSEEK_MAX_RETRIES` - максимальное количество попыток при ошибках (по умолчанию: 3)

## Валидация JSON-ответов

### Основные настройки
- `JSON_VALIDATION_ENABLED` - включить валидацию структурированных JSON-ответов (по умолчанию: True)
- `JSON_VALIDATION_LOG_FAILURES` - логировать неудачные валидации в Event Store (по умолчанию: True)  
- `JSON_VALIDATION_EVENT_BATCH_SIZE` - размер батча для событий валидации (по умолчанию: 10)

## Pydantic модели для структурированных ответов

С версии 2.1.1 система использует Pydantic модели для валидации JSON-ответов:

- `BaseResponse` - базовая модель с обязательным полем `response`
- `TalkResponse` - модель для режима беседы с `emotional_tone` и `engagement_level`
- `ExpertResponse` - модель для экспертного режима с `confidence`, `sources`, `assumptions`
- `CreativeResponse` - модель для творческого режима с `style_markers` и `metaphors`

### Параметры Pydantic валидации
- `PYDANTIC_RESPONSE_MIN_LENGTH` - минимальная длина поля response (по умолчанию: 1)
- `PYDANTIC_CONFIDENCE_MIN` - минимальное значение для confidence/engagement_level (по умолчанию: 0.0)
- `PYDANTIC_CONFIDENCE_MAX` - максимальное значение для confidence/engagement_level (по умолчанию: 1.0)
- `PYDANTIC_STRING_LIST_COERCE` - автоматически преобразовывать элементы списков в строки (по умолчанию: True)
- `PYDANTIC_VALIDATION_STRICT` - строгий режим валидации без приведения типов (по умолчанию: False)

Модели обеспечивают:
- Автоматическую валидацию типов
- Преобразование данных (например, числа в строки для списков)
- Понятные сообщения об ошибках
- Совместимость с будущей ORM интеграцией

### Примечания
1. **Валидация не влияет на работу бота** - это подготовительный механизм для будущих расширений
2. **События валидации** сохраняются в Event Store для анализа качества генерации
3. **Схемы валидации** определены в `models/response_schemas.py` для 4 режимов: base, talk, expert, creative

## Telegram Bot

### Основные настройки
- `TELEGRAM_BOT_TOKEN` - токен бота от BotFather (обязательный)
- `TELEGRAM_POLLING_TIMEOUT` - таймаут long polling в секундах (по умолчанию: 30)
- `TELEGRAM_TYPING_UPDATE_INTERVAL` - интервал обновления typing индикатора (по умолчанию: 5)
- `TELEGRAM_MAX_MESSAGE_LENGTH` - максимальная длина сообщения Telegram (по умолчанию: 4096)
- `TELEGRAM_TYPING_CLEANUP_THRESHOLD` - количество typing операций до автоматической очистки завершенных задач (по умолчанию: 100)
- `TELEGRAM_API_DEFAULT_TIMEOUT` - таймаут по умолчанию для вызовов Telegram API в секундах (по умолчанию: 10)
- `TELEGRAM_MAX_TYPING_TASKS` - максимальное количество одновременных typing индикаторов для защиты от переполнения памяти (по умолчанию: 1000)

### Команды авторизации
- `AUTH_PASSWORD_WAIT_TIMEOUT` - таймаут ожидания пароля после команды /auth в секундах (по умолчанию: 60)
  - После этого времени состояние ожидания автоматически сбрасывается
  - Рекомендация: 30-120 секунд

## Метрики и адаптация

- `CACHE_HIT_LOG_INTERVAL` - частота логирования cache hit rate
- `MIN_CACHE_HIT_RATE` - минимальный приемлемый cache hit rate для адаптивной стратегии

## Pydantic интеграция

### Основные модели системы

- **ActorMessage** - сообщения между акторами
  - Автоматическая генерация message_id
  - Валидация типов полей
  - Сохранена обратная совместимость через __getitem__

- **BaseEvent** - события в Event Store
  - Иммутабельность через frozen=True
  - Валидация version >= 0
  - Методы to_dict/from_dict для сериализации

- **UserSession** - данные сессии пользователя
  - Валидация mode из списка допустимых
  - Валидация mode_confidence в диапазоне 0-1
  - Автоматическое ограничение размера mode_history и cache_metrics
  - Подготовка к будущей ORM интеграции

### Параметры валидации основных структур

- `PYDANTIC_MESSAGE_TYPE_MIN_LENGTH` - минимальная длина message_type (по умолчанию: 0)
- `PYDANTIC_EVENT_TYPE_MIN_LENGTH` - минимальная длина event_type (по умолчанию: 1)
- `PYDANTIC_STREAM_ID_MIN_LENGTH` - минимальная длина stream_id (по умолчанию: 0)
- `PYDANTIC_MODE_HISTORY_MAX_SIZE` - максимальный размер истории режимов (по умолчанию: 10)
- `PYDANTIC_CACHE_METRICS_MAX_SIZE` - максимальный размер метрик кэша (по умолчанию: 100)

### Преимущества Pydantic

1. **Автоматическая валидация** при создании объектов
2. **Строгая типизация** с проверкой во время выполнения
3. **Сериализация/десериализация** через model_dump/model_validate
4. **Готовность к PostgreSQL** - легкая миграция на SQLModel
5. **Лучшие сообщения об ошибках** при невалидных данных

## Short-Term Memory (STM)

### Основные настройки буфера
- `STM_CONTEXT_SIZE_FOR_GENERATION` - количество исторических сообщений для контекста генерации (по умолчанию: 20)
- `STM_BUFFER_SIZE` - количество сообщений для хранения на пользователя (по умолчанию: 50)
  - Меньше значение = меньше памяти, но короче контекст
  - Больше значение = больше контекста, но выше нагрузка на БД
  - Рекомендация: 30-50 для обычных диалогов, 100+ для технических обсуждений

- `STM_CLEANUP_BATCH_SIZE` - количество записей для удаления за одну операцию (по умолчанию: 10)
  - Влияет на производительность операций очистки
  - Меньше = частые небольшие удаления
  - Больше = редкие массивные удаления
  
- `STM_QUERY_TIMEOUT` - таймаут запросов к БД в секундах (по умолчанию: 5.0)
  - Защита от зависших запросов
  - Увеличить при высокой нагрузке на БД

- `STM_MESSAGE_MAX_LENGTH` - максимальная длина одного сообщения перед обрезкой (по умолчанию: 4000)
  - Защита от переполнения БД длинными сообщениями
  - При обрезке в metadata добавляется флаг truncated и original_length
  - Рекомендация: 2000-4000 символов

### Формат контекста
- `STM_CONTEXT_FORMAT` - формат вывода контекста (по умолчанию: "structured")
  - "structured" - формат для DeepSeek API с полями role/content
  - "text" - отладочный формат с type/content/timestamp
  
- `STM_INCLUDE_METADATA` - включать ли метаданные в контекст (по умолчанию: True)
  - True = режимы, эмоции, уверенность будут доступны
  - False = только текст сообщений

- `STM_DEEPSEEK_ROLE_MAPPING` - маппинг ролей для DeepSeek API (по умолчанию: {"user": "user", "bot": "assistant"})
  - Преобразует внутренние типы сообщений в роли для API
  - "user" → "user", "bot" → "assistant"

### Метрики STM
- `STM_METRICS_ENABLED` - включить сбор метрик (по умолчанию: True)
- `STM_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 300)
  - Слишком частое логирование может засорить логи
  - Рекомендация: 300-600 секунд для production
  
- `STM_METRICS_ENABLED` - включить сбор метрик (по умолчанию: True)
- `STM_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 300)
  - Слишком частое логирование может засорить логи
  - Рекомендация: 300-600 секунд для production

- `STM_CONTEXT_REQUEST_TIMEOUT` - таймаут ожидания контекста из памяти в секундах (по умолчанию: 30)
  - Если MemoryActor не ответит за это время, генерация продолжится без исторического контекста
  - Защищает от зависания при проблемах с БД или перегрузке
  - Рекомендация: 10-30 секунд в зависимости от нагрузки

### Рекомендации по настройке

**Для небольших нагрузок (< 100 пользователей):**
- STM_BUFFER_SIZE = 50
- STM_CLEANUP_BATCH_SIZE = 10
- STM_QUERY_TIMEOUT = 5.0

**Для средних нагрузок (100-1000 пользователей):**
- STM_BUFFER_SIZE = 30-40
- STM_CLEANUP_BATCH_SIZE = 20
- STM_QUERY_TIMEOUT = 3.0

**Для высоких нагрузок (> 1000 пользователей):**
- STM_BUFFER_SIZE = 20-30
- STM_CLEANUP_BATCH_SIZE = 50
- STM_QUERY_TIMEOUT = 2.0
- Рассмотрите использование отдельного read-replica для чтения

## Long-Term Memory (LTM)

### Типы памяти и ограничения
- `LTM_MEMORY_TYPES` - допустимые типы воспоминаний (по умолчанию: `['self_related', 'world_model', 'user_related']`)
  - `self_related` - воспоминания о самой Химере, её идентичности
  - `world_model` - знания о мире, фактах, концепциях
  - `user_related` - информация о пользователе и взаимодействии с ним

### Ограничения оценок
- `LTM_SCORE_MIN` - минимальное значение для всех score полей (по умолчанию: 0.0)
- `LTM_SCORE_MAX` - максимальное значение для всех score полей (по умолчанию: 1.0)
  - Используется для валидации importance_score, emotional_intensity, self_relevance_score

### Ограничения длины полей
- `LTM_USER_ID_MAX_LENGTH` - максимальная длина user_id (по умолчанию: 255)
- `LTM_MEMORY_TYPE_MAX_LENGTH` - максимальная длина типа памяти (по умолчанию: 50)
- `LTM_TRIGGER_REASON_MAX_LENGTH` - максимальная длина причины сохранения (по умолчанию: 100)
- `LTM_MESSAGE_CONTENT_MAX_LENGTH` - максимальная длина контента сообщения (по умолчанию: 2000)
  - При превышении сообщение обрезается
  - Рекомендация: 1500-2000 для сохранения контекста без перегрузки БД

### Ограничения массивов
- `LTM_DOMINANT_EMOTIONS_MAX_SIZE` - максимальное количество доминирующих эмоций (по умолчанию: 10)
  - Обычно достаточно 3-5 для характеристики эмоционального состояния
- `LTM_SEMANTIC_TAGS_MAX_SIZE` - максимальное количество семантических тегов (по умолчанию: 20)
  - Рекомендация: 10-20 тегов для баланса между детализацией и производительностью

### Настройки фрагмента диалога
- `LTM_CONVERSATION_FRAGMENT_MAX_MESSAGES` - максимальное количество сообщений в фрагменте (по умолчанию: 10)
  - Определяет размер контекстного окна вокруг триггерного сообщения
  - Больше = лучше контекст, но больше размер записи
- `LTM_CONVERSATION_FRAGMENT_DEFAULT_WINDOW` - размер окна контекста по умолчанию (по умолчанию: 5)
  - Количество сообщений до и после триггера для сохранения
  - Рекомендация: 3-7 сообщений для оптимального контекста

### Причины сохранения в LTM
- `LTM_TRIGGER_REASONS` - список допустимых причин сохранения (по умолчанию: 7 причин)
  - `emotional_peak` - пиковое эмоциональное состояние (любая эмоция > 0.8)
  - `emotional_shift` - резкое изменение эмоционального состояния
  - `self_reference` - упоминание Химеры, вопросы о её природе
  - `deep_insight` - философские размышления, глубокие мысли
  - `personal_revelation` - важная личная информация пользователя
  - `relationship_change` - изменение в отношениях пользователя и Химеры
  - `creative_breakthrough` - особо удачная творческая генерация

### Эмоциональные пороги
- `LTM_EMOTIONAL_PEAK_THRESHOLD` - порог для определения эмоционального пика (по умолчанию: 0.8)
  - Если любая эмоция превышает этот порог, событие считается эмоционально значимым
  - Рекомендация: 0.7-0.9 для баланса между чувствительностью и шумом
- `LTM_EMOTIONAL_SHIFT_THRESHOLD` - порог для определения эмоционального сдвига (по умолчанию: 0.5)
  - Минимальная разница между эмоциями для регистрации изменения
  - Рекомендация: 0.4-0.6 для отслеживания значимых перепадов
- `LTM_EMOTIONAL_THRESHOLD` - порог эмоциональной интенсивности для сохранения в долговременную память (по умолчанию: 0.6)
  - Минимальное значение максимальной эмоции (кроме neutral) для триггера сохранения
  - Рекомендация: 0.6 для ~1-5% сообщений, 0.7 для ~0.5-2%, 0.5 для ~5-10%

### Значения по умолчанию
- `LTM_DEFAULT_ACCESS_COUNT` - начальное количество обращений к воспоминанию (по умолчанию: 0)
- `LTM_DEFAULT_SELF_RELEVANCE_SCORE` - релевантность для самоидентификации (по умолчанию: None)
  - None означает, что поле опционально и может не заполняться

### Настройки LTMActor
- `LTM_QUERY_TIMEOUT` - таймаут запросов к БД в секундах (по умолчанию: 5.0)
  - Защита от зависших запросов при работе с большими объемами данных
  - Увеличить при медленной БД или сложных запросах
- `LTM_METRICS_ENABLED` - включить сбор метрик (по умолчанию: True)
  - Отключить в production для экономии ресурсов
- `LTM_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 300)
  - Каждые 5 минут выводится статистика операций
  - Рекомендация: 300-600 секунд для баланса информативности и чистоты логов
- `LTM_SCHEMA_CHECK_TIMEOUT` - таймаут проверки схемы БД в секундах (по умолчанию: 5.0)
  - Время на проверку существования таблиц и индексов при инициализации
  
### Настройки векторизации (Embeddings)

#### Модель и устройство
- `LTM_EMBEDDING_MODEL` - модель для генерации embeddings (по умолчанию: `"sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"`)
  - Мультиязычная модель, поддерживает русский язык
  - Генерирует 384-мерные векторы для текста
  - Альтернативы: `"sentence-transformers/all-MiniLM-L6-v2"` (английский, быстрее)
- `LTM_EMBEDDING_DEVICE` - устройство для вычислений (по умолчанию: `"cpu"`)
  - `"cpu"` - для систем без GPU
  - `"cuda"` - для систем с NVIDIA GPU (ускорение в 5-10 раз)
- `LTM_EMBEDDING_CACHE_DIR` - директория для кэша моделей (по умолчанию: `"./models/cache"`)
  - Модель загружается один раз и кэшируется
  - Размер кэша ~400MB для данной модели

#### Размерности композитного embedding
Общий размер: 768 измерений, разделенных на компоненты:
- `LTM_EMBEDDING_SEMANTIC_DIM` - семантический компонент (по умолчанию: 384)
  - Основной смысл текста сообщений
  - Получается напрямую из sentence-transformers
- `LTM_EMBEDDING_EMOTIONAL_DIM` - эмоциональный компонент (по умолчанию: 128)
  - Кодирует 28 эмоций из DeBERTa анализа
  - Расширяется через производные признаки
- `LTM_EMBEDDING_TEMPORAL_DIM` - временной компонент (по умолчанию: 64)
  - Кодирует время суток, день недели, месяц
  - Использует синусоидальное кодирование
- `LTM_EMBEDDING_PERSONAL_DIM` - персональный компонент (по умолчанию: 192)
  - Тип памяти (one-hot encoding)
  - Семантические теги

#### Параметры обработки
- `LTM_EMBEDDING_BATCH_SIZE` - размер батча для обработки (по умолчанию: 32)
- `LTM_EMBEDDING_MAX_LENGTH` - максимальная длина текста в символах (по умолчанию: 512)
  - Тексты длиннее обрезаются перед векторизацией
  - Оптимально для баланса качества/скорости
- `LTM_EMBEDDING_NORMALIZE` - нормализовать векторы (по умолчанию: True)
  - True - векторы нормализуются к единичной длине
  - Необходимо для корректной работы cosine similarity в pgvector

#### Параметры поиска в LTM
- `LTM_SEARCH_MAX_LIMIT` - максимальное количество результатов за один поиск (по умолчанию: 100)
  - Защита от чрезмерно больших выборок
  - Все методы поиска автоматически ограничивают limit этим значением
- `LTM_SEARCH_DEFAULT_LIMIT` - количество результатов по умолчанию (по умолчанию: 10)
  - Используется когда limit не указан явно в запросе
  - Оптимально для большинства сценариев использования
- `LTM_SEARCH_TAGS_MODE_ANY` - режим поиска по тегам "хотя бы один" (по умолчанию: 'any')
  - Находит записи, содержащие хотя бы один из указанных тегов
  - SQL оператор: `semantic_tags && ARRAY[...]`
- `LTM_SEARCH_TAGS_MODE_ALL` - режим поиска по тегам "все теги" (по умолчанию: 'all')
  - Находит записи, содержащие все указанные теги
  - SQL оператор: `semantic_tags @> ARRAY[...]`
- `LTM_SEARCH_RECENT_DAYS_DEFAULT` - период поиска недавних воспоминаний в днях (по умолчанию: 7)
  - Используется в методе `get_recent_memories` когда days не указан
  - Оптимально для недельного контекста взаимодействий
- `LTM_SEARCH_MIN_IMPORTANCE_DEFAULT` - минимальная важность для поиска (по умолчанию: 0.8)
  - Используется в методе `get_memories_by_importance` когда min_score не указан
  - Значение 0.8 соответствует высокой важности воспоминаний
  
#### Параметры аналитики LTM

##### Поиск по эмоциональному сходству
- `LTM_ANALYTICS_SIMILARITY_THRESHOLD` - минимальное косинусное сходство для поиска (по умолчанию: 0.7)
  - Диапазон: 0.0-1.0, где 1.0 - идентичные эмоциональные состояния
  - Рекомендуется 0.6-0.8 для поиска похожих настроений
- `LTM_ANALYTICS_EMOTIONAL_SIMILARITY_LIMIT` - максимальное количество результатов (по умолчанию: 10)
  - Ограничивает выборку для защиты от больших данных
  - Увеличьте для более широкого анализа

##### Детекция паттернов
- `LTM_ANALYTICS_PATTERN_MIN_OCCURRENCES` - минимум повторений для паттерна (по умолчанию: 3)
  - Определяет порог для "устойчивого" паттерна
  - Меньше 3 - слишком шумно, больше 5 - пропустите редкие паттерны

##### Эмоциональные траектории
- `LTM_ANALYTICS_TRAJECTORY_DEFAULT_DAYS` - временное окно анализа в днях (по умолчанию: 30)
  - Стандартный период для построения эмоциональной динамики
  - 7 дней - недельные циклы, 30 - месячные тренды
- `LTM_ANALYTICS_TRAJECTORY_DEFAULT_GRANULARITY` - детализация времени (по умолчанию: 'day')
  - Варианты: 'hour', 'day', 'week'
  - 'hour' - для детального анализа суточных ритмов
  - 'day' - стандартная динамика настроения
  - 'week' - долгосрочные тренды

##### Анализ концептуальных ассоциаций
- `LTM_ANALYTICS_CONCEPT_ASSOCIATIONS_LIMIT` - лимит воспоминаний для анализа концепта (по умолчанию: 20)
  - Ограничивает выборку при поиске ассоциаций
  - Баланс между полнотой анализа и производительностью

##### Определение трендов
- `LTM_ANALYTICS_TREND_INCREASE_THRESHOLD` - порог роста эмоции (по умолчанию: 0.05)
  - Минимальное среднее изменение для тренда "рост"
  - 0.05 = рост на 5% между точками траектории
- `LTM_ANALYTICS_TREND_DECREASE_THRESHOLD` - порог снижения эмоции (по умолчанию: -0.05)
  - Максимальное среднее изменение для тренда "спад"
  - -0.05 = снижение на 5% между точками

##### Поиск по настроению
- `LTM_ANALYTICS_MOOD_MATCH_THRESHOLD` - минимальный вес для совпадения настроения (по умолчанию: 0.3)
  - Взвешенное косинусное сходство с учетом emotional_intensity
  - 0.3 = умеренное совпадение, 0.5+ = сильное совпадение

##### Распределение важности
- `LTM_ANALYTICS_HISTOGRAM_BUCKETS` - количество интервалов гистограммы (по умолчанию: 10)
  - Для анализа распределения importance_score (0.0-1.0)
  - 10 buckets = интервалы по 0.1 (0-0.1, 0.1-0.2, ...)
- `LTM_ANALYTICS_ANOMALY_STD_DEVS` - стандартные отклонения для аномалий (по умолчанию: 2)
  - Порог определения "аномально важных" воспоминаний
  - 2 σ = ~95% доверительный интервал, выбросы за его пределами
  
### Параметры оценки новизны

#### Веса факторов новизны (должны давать в сумме 1.0)
- `LTM_NOVELTY_SEMANTIC_WEIGHT` - вес семантического расстояния в общей оценке (по умолчанию: 0.4)
  - Определяет важность смысловой уникальности текста относительно существующих воспоминаний
  - Рекомендация: 0.35-0.45 для баланса между новыми темами и повторяющимися
- `LTM_NOVELTY_EMOTIONAL_WEIGHT` - вес эмоциональной редкости (по умолчанию: 0.25)
  - Учитывает насколько редки эмоции в контексте конкретного пользователя
  - Рекомендация: 0.2-0.3 для приоритета уникальных эмоциональных состояний
- `LTM_NOVELTY_CONTEXT_WEIGHT` - вес редкости семантических тегов (по умолчанию: 0.2)
  - Оценивает уникальность тематики на основе частотности тегов
  - Рекомендация: 0.15-0.25 в зависимости от разнообразия диалогов
- `LTM_NOVELTY_TEMPORAL_WEIGHT` - вес временной новизны (по умолчанию: 0.15)
  - Учитывает время с последнего обсуждения похожей темы
  - Рекомендация: 0.1-0.2 для естественного "забывания" старых тем

#### Параметры холодного старта
- `LTM_COLD_START_BUFFER_SIZE` - количество сообщений для калибровки (по умолчанию: 30)
  - Первые N сообщений накапливают статистику без сохранения в LTM
  - Рекомендация: 20-50 для адекватной начальной калибровки
- `LTM_COLD_START_MIN_THRESHOLD` - минимальный порог новизны (по умолчанию: 0.8)
  - Абсолютный минимум для сохранения даже после калибровки
  - Рекомендация: 0.75-0.85 для защиты от переполнения
- `LTM_NOVELTY_SCORES_WINDOW` - размер окна последних оценок (по умолчанию: 100)
  - Количество последних оценок для расчета динамического 90-го перцентиля
  - Рекомендация: 50-200 в зависимости от интенсивности общения

#### Параметры локальной плотности (KNN)
- `LTM_KNN_NEIGHBORS` - количество ближайших соседей для оценки плотности (по умолчанию: 5)
  - Определяет размер локального региона в пространстве embeddings
  - Рекомендация: 3-7 для баланса между локальностью и статистической значимостью
- `LTM_KNN_DENSITY_THRESHOLD` - порог расстояния для "плотного" региона (по умолчанию: 0.2)
  - Если среднее расстояние до соседей меньше порога - регион считается плотным
  - Рекомендация: 0.15-0.25 в зависимости от желаемой чувствительности
- `LTM_KNN_DENSITY_PENALTY` - снижение веса в плотных регионах (по умолчанию: 0.3)
  - На сколько уменьшается итоговая оценка новизны в переполненных областях
  - Рекомендация: 0.2-0.4 для предотвращения дублирования похожих воспоминаний

#### Пороги обработки эмоций
- `LTM_EMOTION_FREQUENCY_THRESHOLD` - минимальное значение эмоции для учета (по умолчанию: 0.1)
  - Эмоции ниже порога считаются шумом и не учитываются в частотностях
  - Рекомендация: 0.05-0.15 для фильтрации незначительных эмоций
- `LTM_PERCENTILE_MIN_SAMPLES` - минимум оценок для расчета перцентиля (по умолчанию: 20)
  - До накопления N оценок используется статический порог
  - Рекомендация: 15-30 для статистической достоверности
  
- `LTM_MATURITY_SIGMOID_RATE` - скорость адаптации профиля (по умолчанию: 0.1)
  - Определяет, как быстро снижается строгость отбора воспоминаний по мере развития отношений
  - Рекомендация: 0.05-0.1 для постепенной адаптации за 2-3 месяца, 0.15-0.2 для быстрой за месяц
  
#### Параметры генерации embeddings
- `LTM_EMBEDDING_THREAD_POOL_SIZE` - размер пула потоков для асинхронной генерации векторов (по умолчанию: 2)
  - Определяет количество параллельных потоков для генерации embeddings
  - Рекомендация: 2-4 для баланса между производительностью и потреблением памяти
  - Увеличение может ускорить обработку при большом потоке сообщений
- `LTM_EMBEDDING_GENERATION_TIMEOUT` - таймаут генерации одного embedding в секундах (по умолчанию: 10.0)
  - Максимальное время ожидания генерации вектора перед отказом
  - Рекомендация: 5-15 секунд в зависимости от производительности системы
  - Примечание: параметр зарезервирован для будущих версий, пока не используется
- `LTM_EMBEDDING_REQUEST_TIMEOUT` - максимальное время ожидания генерации embedding (по умолчанию: 2.0)
  - Если embedding не сгенерируется за это время, произойдет fallback на поиск типа 'recent'
  - Рекомендация: 1.5-3.0 секунд, учитывая что генерация использует ThreadPoolExecutor
- `LTM_VECTOR_CACHE_TTL` - время жизни кэша результатов векторного поиска (по умолчанию: 3600)
  - Кэширует результаты векторного поиска в Redis для идентичных запросов
  - Рекомендация: 1800-7200 секунд (30 мин - 2 часа) в зависимости от частоты обновления LTM
  
### Настройки запросов к LTM
- `LTM_REQUEST_TIMEOUT` - максимальное время ожидания ответа от LTM (по умолчанию: 0.5)
  - Если LTM не ответит за это время, генерация продолжится только с STM контекстом
  - Рекомендация: 0.3-0.7 секунд для баланса между полнотой и скоростью ответа
- `LTM_CONTEXT_LIMIT` - максимальное количество воспоминаний из LTM (по умолчанию: 3)
  - Ограничивает объем контекста для предотвращения перегрузки модели
  - Рекомендация: 2-5 воспоминаний в зависимости от их типичной длины
- `LTM_REQUEST_ENABLED` - глобальное включение/выключение LTM (по умолчанию: True)
  - Позволяет быстро отключить интеграцию без изменения кода
  - Рекомендация: использовать для A/B тестирования или при проблемах с производительностью
- `LTM_DEFAULT_SEARCH_TYPE` - тип поиска при отсутствии специфичных триггеров (по умолчанию: "recent")
  - Определяет стратегию поиска для общих триггеров памяти
  - Доступные значения: "recent", "importance", "vector"
- `LTM_EMOTIONAL_SEARCH_THRESHOLD` - порог эмоциональной интенсивности для активации поиска в LTM (по умолчанию: 0.7)
  - При превышении автоматически запускается векторный поиск похожих эмоциональных контекстов
  - Работает независимо от текстовых триггеров, дополняя их эмоциональным слоем

### Семантические теги
- `LTM_SEMANTIC_TAG_KEYWORDS` - словарь категорий и ключевых слов для извлечения тегов
  - Определяет тематические категории воспоминаний через поиск ключевых слов
  - Структура: `{'category_name': ['keyword1', 'keyword2', ...]}`
  - Рекомендация: использовать основы слов для охвата словоформ ('люб' найдет 'люблю', 'любовь')
  
### Триггеры активации LTM
- `LTM_TRIGGER_KEYWORDS` - словарь категорий триггеров и ключевых слов для активации LTM
  - Определяет когда и какой тип поиска воспоминаний использовать
  - Структура: `{'trigger_category': ['keyword1', 'keyword2', ...]}`
  - Категории:
    - `self_related`: триггеры для поиска воспоминаний о самой Химере
    - `memory_recall`: явные запросы на воспоминания
    - `past_reference`: ссылки на прошлые диалоги
  - Рекомендация: добавлять новые категории для специфичных типов поиска
  

  
#### Основные параметры кэширования LTM
- `LTM_CACHE_ENABLED` - включение Redis кэширования для LTM (по умолчанию: True)
  - Глобальный переключатель для всей системы кэширования LTM
  - Рекомендация: отключать только при отладке или отсутствии Redis
- `LTM_CACHE_KEY_PREFIX` - префикс для всех ключей кэша LTM (по умолчанию: "ltm")
  - Изолирует ключи LTM от других подсистем в Redis
  - Рекомендация: изменять только при конфликте с другими префиксами
- `LTM_CACHE_DEFAULT_TTL` - время жизни кэша по умолчанию в секундах (по умолчанию: 1800)
  - Используется для всех записей без явного TTL
  - Рекомендация: 1800-3600 сек (30-60 мин) для баланса между производительностью и актуальностью

#### Параметры кэширования результатов новизны
- `LTM_NOVELTY_CACHE_TTL` - TTL для финальных результатов оценки новизны (по умолчанию: 1800)
  - Время хранения комплексной оценки новизны (score + факторы)
  - Рекомендация: 1800-3600 сек, увеличивать при стабильном профиле пользователя
- `LTM_NOVELTY_CACHE_LOG_INTERVAL` - интервал логирования статистики кэша (по умолчанию: 100)
  - Через сколько запросов выводить hit rate и статистику
  - Рекомендация: 100-500 для production, 10-50 для отладки

#### Параметры кэширования промежуточных вычислений
- `LTM_EMBEDDING_CACHE_TTL` - TTL для векторных представлений текста (по умолчанию: 3600)
  - Embeddings неизменны для одного текста, можно хранить дольше
  - Рекомендация: 3600-7200 сек (1-2 часа) или больше при стабильной модели
- `LTM_KNN_CACHE_TTL` - TTL для результатов поиска ближайших соседей (по умолчанию: 900)
  - Инвалидируется при сохранении новых воспоминаний
  - Рекомендация: 600-1800 сек (10-30 мин) в зависимости от частоты новых воспоминаний
- `LTM_TEMPORAL_CACHE_TTL` - TTL для временного анализа по тегам (по умолчанию: 1200)
  - Инвалидируется при появлении воспоминаний с новыми тегами
  - Рекомендация: 900-1800 сек (15-30 мин) для актуальности временных паттернов
- `LTM_PROFILE_CACHE_TTL` - TTL для полного профиля пользователя (по умолчанию: 21600)
  - Содержит статистику эмоций, тегов, историю оценок новизны
  - Рекомендация: 14400-28800 сек (4-8 часов) для активных пользователей, можно увеличить для редких
  
- `LTM_PERCENTILE_CACHE_TTL` - TTL для перцентилей порогов новизны (по умолчанию: 3600)
  - Обновляется при каждом новом сообщении, критичен для точности оценки
  - Рекомендация: 1800-3600 сек (30-60 мин) для баланса актуальности и производительности
  
- `LTM_CALIBRATION_CACHE_TTL` - TTL для статуса калибровки пользователя (по умолчанию: 7200)
  - Меняется редко (только при переходе через порог в 10 сообщений)
  - Рекомендация: 7200-14400 сек (2-4 часа) или больше, так как изменения редки
  
- `LTM_CACHE_METRICS_ENABLED` - Включение сбора метрик кэширования (по умолчанию: True)
  - Позволяет отслеживать эффективность кэша через события и логи
  - Рекомендация: True для production, можно отключить только при критичной нагрузке
  
- `LTM_CACHE_HIT_RATE_ALERT` - Порог для предупреждения о низком hit rate (по умолчанию: 0.5)
  - При падении hit rate ниже порога можно алертить (функционал для будущего мониторинга)
  - Рекомендация: 0.4-0.6 в зависимости от паттернов использования системы

### Параметры политики хранения (Retention Policy)
- `LTM_CLEANUP_ENABLED` - включение автоматической очистки (по умолчанию: True)
  - True для продакшн, False для отладки или архивных систем
  - Рекомендация: True для контроля роста БД
- `LTM_RETENTION_DAYS` - срок хранения воспоминаний в днях (по умолчанию: 365)
  - Воспоминания старше этого срока становятся кандидатами на удаление
  - Рекомендация: 365-730 дней в зависимости от объема БД
- `LTM_RETENTION_MIN_IMPORTANCE` - минимальная важность для сохранения после срока (по умолчанию: 0.8)
  - Воспоминания с importance ниже этого порога будут удалены
  - Рекомендация: 0.7-0.85 для баланса между объемом и ценностью
- `LTM_RETENTION_CRITICAL_IMPORTANCE` - порог критической важности (по умолчанию: 0.95)
  - Воспоминания выше этого порога НИКОГДА не удаляются
  - Рекомендация: 0.95-0.99 для сохранения только уникальных моментов
- `LTM_RETENTION_MIN_ACCESS_COUNT` - минимум обращений для защиты от удаления (по умолчанию: 5)
  - Часто используемые воспоминания сохраняются независимо от возраста
  - Рекомендация: 3-10 в зависимости от активности пользователей

### Параметры выполнения очистки (Cleanup Execution)
- `LTM_CLEANUP_BATCH_SIZE` - размер батча для удаления (по умолчанию: 1000)
  - Меньше батч = меньше блокировок, больше батч = быстрее очистка
  - Рекомендация: 500-2000 в зависимости от производительности БД
- `LTM_CLEANUP_QUERY_TIMEOUT` - таймаут запросов очистки в секундах (по умолчанию: 30.0)
  - Защита от зависших запросов при больших объемах
  - Рекомендация: 20-60 сек в зависимости от размера таблиц
- `LTM_CLEANUP_SCHEDULE_HOUR` - час запуска очистки UTC (по умолчанию: 3)
  - Выбирайте время минимальной активности системы
  - Рекомендация: 2-5 часов UTC (ночь в Европе/России)
- `LTM_CLEANUP_SCHEDULE_MINUTE` - минута запуска (по умолчанию: 0)
  - Можно сместить для избежания конфликтов с другими задачами
  - Рекомендация: 0-30 для распределения нагрузки
- `LTM_CLEANUP_DRY_RUN` - режим сухого прогона (по умолчанию: False)
  - True = только логирование без реального удаления
  - Рекомендация: True для первого запуска в продакшн, затем False

### Параметры генерации summary

- `LTM_SUMMARY_ENABLED` - создавать ли агрегированные summary (по умолчанию: True)
  - Summary сохраняют историческую статистику удаленных периодов
  - Рекомендация: True для сохранения исторического контекста
- `LTM_SUMMARY_PERIOD` - период агрегации (по умолчанию: 'month')
  - Варианты: 'week', 'month', 'quarter'
  - Рекомендация: 'month' для баланса детализации и объема
- `LTM_SUMMARY_MIN_MEMORIES` - минимум воспоминаний для создания summary (по умолчанию: 5)
  - Меньше порог = больше summary, но менее значимые
  - Рекомендация: 3-10 в зависимости от активности пользователей
- `LTM_SUMMARY_TOP_EMOTIONS` - количество топ эмоций в summary (по умолчанию: 5)
  - Сохраняет N самых частых эмоций периода
  - Рекомендация: 5-10 для покрытия основного спектра
- `LTM_SUMMARY_TOP_TAGS` - количество топ тегов в summary (по умолчанию: 10)
  - Сохраняет N самых частых семантических тегов
  - Рекомендация: 10-20 для сохранения тематического контекста

### Параметры инвалидации кэша
- `LTM_CLEANUP_INVALIDATE_CACHE` - очищать ли кэши после cleanup (по умолчанию: True)
  - Обеспечивает актуальность кэшированных данных novelty
  - Рекомендация: True для консистентности данных
- `LTM_CLEANUP_INVALIDATE_PATTERNS` - паттерны кэша для очистки (по умолчанию: список)
  - Указывает какие типы кэшей инвалидировать
  - Рекомендация: включить все типы novelty кэшей для полной очистки

### Параметры логирования и мониторинга
- `LTM_CLEANUP_LOG_LEVEL` - уровень логирования операций cleanup (по умолчанию: 'INFO')
  - DEBUG для отладки, INFO для продакшн, WARNING для минимального вывода
  - Рекомендация: INFO для баланса информативности и объема логов
- `LTM_CLEANUP_EMIT_EVENTS` - генерировать ли события для Event Store (по умолчанию: True)
  - События позволяют отслеживать историю всех cleanup операций
  - Рекомендация: True для аудита и аналитики


## Emotion Analysis (DeBERTa)

### Модель и производительность
- `EMOTION_MODEL_NAME` - название модели на HuggingFace (по умолчанию: "fyaronskiy/deberta-v1-base-russian-go-emotions")
  - Предобученная DeBERTa-v1 для русского языка
  - Поддерживает 28 категорий эмоций
  - Средний F1-score: 0.48

- `EMOTION_MODEL_DEVICE` - устройство для выполнения (по умолчанию: "cpu")
  - "cpu" - использовать процессор
  - "cuda" - использовать GPU (автоматический fallback на CPU если недоступна)
  - Рекомендация: GPU ускоряет анализ в 5-10 раз

- `EMOTION_MODEL_CACHE_DIR` - директория для кэширования загруженной модели (по умолчанию: "./models/cache")
  - Модель загружается один раз и кэшируется (~400MB)
  - Убедитесь в наличии свободного места

### Параметры анализа
- `EMOTION_CONFIDENCE_THRESHOLD` - общий порог уверенности для метрик (по умолчанию: 0.5)
  - Используется для агрегированных метрик
  - Индивидуальные пороги для каждой эмоции заданы в коде

- `EMOTION_MODEL_MAX_LENGTH` - максимальная длина текста в токенах (по умолчанию: 128)
  - Ограничение модели DeBERTa
  - Тексты автоматически обрезаются

### Логирование эмоций
- `EMOTION_EMOJI_MAP` - маппинг эмоций на эмодзи для логов (словарь с 28 эмоциями)
- `EMOTION_LOG_PREDICTIONS` - логировать ли предсказания эмоций (по умолчанию: True)
  - Полезно для отладки и анализа работы
  - Может создавать много логов при высокой нагрузке

- `EMOTION_LOG_THRESHOLD` - минимальная вероятность эмоции для логирования (по умолчанию: 0.3)
  - Эмоции с вероятностью ниже не логируются
  - Снижает объем логов
  
### Пороговые значения эмоций
- `EMOTION_THRESHOLDS` - список пороговых значений для каждой из 28 эмоций
  - Порядок соответствует EMOTION_LABELS
  - Значения от 0.0 до 1.0
  - Чем выше порог, тем реже эмоция будет определяться
  - Рекомендация: увеличить порог для 'neutral' (последний элемент) если она слишком часто доминирует

- `EMOTION_LABELS` - список названий эмоций на английском
  - 28 эмоций в порядке индексов модели
  - Не изменять порядок!

- `EMOTION_LABELS_RU` - словарь для перевода эмоций на русский
  - Используется для отображения в логах
  - Можно изменять переводы по желанию
  
### Рекомендации по настройке

**Для разработки:**
- EMOTION_MODEL_DEVICE = "cpu"
- EMOTION_LOG_PREDICTIONS = True
- EMOTION_LOG_THRESHOLD = 0.3

**Для production:**
- EMOTION_MODEL_DEVICE = "cuda" (при наличии GPU)
- EMOTION_LOG_PREDICTIONS = False
- EMOTION_LOG_THRESHOLD = 0.5

**Оптимизация производительности:**
- Модель загружается один раз при инициализации EmotionAnalyzer
- Анализ одного текста: ~50ms на GPU, ~150ms на CPU
- Рекомендуется батчевая обработка для высоких нагрузок (будет в PerceptionActor)
  
## Интеграция эмоций с потоком сообщений

Параметры для автоматического анализа эмоций в сообщениях пользователей.

### Основные параметры
- `EMOTION_ANALYSIS_ENABLED` - включить автоматический анализ эмоций (по умолчанию: True)
  - True - каждое сообщение анализируется на эмоции
  - False - анализ отключен (для экономии ресурсов)

- `EMOTION_PEAK_THRESHOLD` - порог для генерации EmotionalPeakEvent (по умолчанию: 0.8)
  - События высокой эмоциональности (будет в этапе 4.3)
  - Значения выше порога считаются эмоциональными пиками

- `EMOTION_TEXT_PREVIEW_LENGTH` - длина превью текста в событиях (по умолчанию: 50)
  - Сколько символов сохранять в событии
  - Для приватности полный текст не сохраняется
  
## Настройки PerceptionActor

Параметры для актора анализа эмоций.

### Основные параметры
- `PERCEPTION_EMOTION_TIMEOUT` - таймаут для анализа одного текста в секундах (по умолчанию: 5.0)
  - Защищает от зависания при анализе сложных текстов
  - При превышении возвращается нейтральный эмоциональный вектор

- `PERCEPTION_THREAD_POOL_SIZE` - размер пула потоков для асинхронного анализа (по умолчанию: 3)
  - Определяет количество параллельных анализов
  - Увеличьте для высоких нагрузок

- `PERCEPTION_LOG_ERRORS` - логировать ли ошибки анализа эмоций (по умолчанию: True)
  - Полезно для отладки
  - В production можно отключить для уменьшения логов

### Рекомендации по настройке

**Для разработки:**
- PERCEPTION_EMOTION_TIMEOUT = 5.0
- PERCEPTION_THREAD_POOL_SIZE = 3
- PERCEPTION_LOG_ERRORS = True

**Для production:**
- PERCEPTION_EMOTION_TIMEOUT = 2.0 (быстрее отказ при проблемах)
- PERCEPTION_THREAD_POOL_SIZE = 5-10 (в зависимости от нагрузки)
- PERCEPTION_LOG_ERRORS = False

## Авторизация и управление доступом

### Параметры паролей
- `PASSWORD_DURATIONS` - список допустимых сроков действия паролей в днях (по умолчанию: [30, 90, 180, 365])
  - Используется при создании новых паролей администратором
  - Проверяется при валидации в Pydantic моделях

### Anti-bruteforce защита
- `AUTH_MAX_ATTEMPTS` - количество неудачных попыток авторизации до блокировки (по умолчанию: 5)
- `AUTH_BLOCK_DURATION` - длительность блокировки пользователя в секундах (по умолчанию: 900 = 15 минут)
- `AUTH_ATTEMPTS_WINDOW` - окно времени для подсчета неудачных попыток в секундах (по умолчанию: 900 = 15 минут)
  - Попытки старше этого времени не учитываются при подсчете
  - Должно быть равно или больше AUTH_BLOCK_DURATION

### Администрирование
- `ADMIN_USER_IDS` - список telegram_id пользователей с правами администратора (по умолчанию: [502312936])
  - Только эти пользователи могут использовать админские команды
  - Добавляйте ID через запятую: [502312936, 123456789]

### Интеграция с системой
- `AUTH_CHECK_TIMEOUT` - таймаут ожидания ответа от AuthActor при проверке лимитов (по умолчанию: 2.0 секунды)
- `AUTH_FALLBACK_TO_DEMO` - разрешить работу в демо-режиме если AuthActor недоступен (по умолчанию: True)
  - True = при недоступности AuthActor пользователи работают с демо-лимитами
  - False = при недоступности AuthActor доступ блокируется
- `AUTH_ATTEMPTS_WINDOW` - окно подсчета попыток в секундах (по умолчанию: 900)
- `AUTH_DAILY_RESET_ENABLED` - включить ежедневный сброс счетчиков (по умолчанию: True)
- `AUTH_DAILY_RESET_HOUR` - час сброса в UTC (по умолчанию: 0)
- `AUTH_CIRCUIT_BREAKER_ENABLED` - включить Circuit Breaker для AUTH_REQUEST (по умолчанию: True)
- `AUTH_CIRCUIT_BREAKER_THRESHOLD` - количество ошибок для открытия (по умолчанию: 3)
- `AUTH_CIRCUIT_BREAKER_TIMEOUT` - время восстановления в секундах (по умолчанию: 300)
  
## AUTH ACTOR SETTINGS

Настройки для актора авторизации AuthActor.

### Проверка схемы БД
- `AUTH_SCHEMA_CHECK_TIMEOUT` - таймаут проверки существования таблиц авторизации в секундах (по умолчанию: 5.0)
  - Защищает от зависания при проблемах с БД
  - Рекомендация: 3-10 секунд

### Фоновые задачи
- `AUTH_CLEANUP_INTERVAL` - интервал очистки старых данных авторизации в секундах (по умолчанию: 3600 = 1 час)
  - Очищает старые записи из auth_attempts
  - Удаляет истекшие блокировки из blocked_users
  - Установите 0 для отключения очистки

- `AUTH_METRICS_LOG_INTERVAL` - интервал логирования метрик AuthActor в секундах (по умолчанию: 300 = 5 минут)
  - Выводит статистику проверок лимитов и авторизаций
  - Показывает процент успешных авторизаций
  - Установите 0 для отключения периодических метрик

### Рекомендации по настройке

**Для разработки:**
- AUTH_SCHEMA_CHECK_TIMEOUT = 5.0
- AUTH_CLEANUP_INTERVAL = 300 (5 минут)
- AUTH_METRICS_LOG_INTERVAL = 60 (1 минута)

**Для production:**
- AUTH_SCHEMA_CHECK_TIMEOUT = 3.0
- AUTH_CLEANUP_INTERVAL = 3600 (1 час)
- AUTH_METRICS_LOG_INTERVAL = 300 (5 минут)

## Circuit Breaker
- `CIRCUIT_BREAKER_ENABLED` - включить механизм Circuit Breaker (по умолчанию: True)
- `CIRCUIT_BREAKER_FAILURE_THRESHOLD` - количество ошибок для открытия (по умолчанию: 5)
- `CIRCUIT_BREAKER_RECOVERY_TIMEOUT` - время восстановления в секундах (по умолчанию: 60)
